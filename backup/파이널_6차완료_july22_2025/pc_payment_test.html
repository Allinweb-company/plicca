<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PC 결제 테스트 진단</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .diagnostic-card {
            background: linear-gradient(135deg, #1a1d23 0%, #2d3748 100%);
            border: 1px solid #4a5568;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .test-result {
            padding: 10px;
            border-radius: 8px;
            margin: 5px 0;
        }
        .test-pass { background-color: #065f46; border: 1px solid #059669; }
        .test-fail { background-color: #7f1d1d; border: 1px solid #dc2626; }
        .test-warn { background-color: #78350f; border: 1px solid #d97706; }
    </style>
</head>
<body class="bg-dark text-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="diagnostic-card p-4">
                    <div class="text-center mb-4">
                        <h2 class="text-info">
                            <i class="fas fa-desktop me-2"></i>
                            PC 결제 문제 진단 도구
                        </h2>
                        <p class="text-muted">PC에서 결제가 안되는 원인을 찾아보겠습니다</p>
                    </div>

                    <!-- 진단 결과 영역 -->
                    <div id="diagnosticResults" class="mb-4">
                        <h5 class="text-warning mb-3">
                            <i class="fas fa-search me-2"></i>
                            진단 결과
                        </h5>
                        <div id="testResults"></div>
                    </div>

                    <!-- 환경 정보 -->
                    <div class="mb-4">
                        <h5 class="text-warning mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            브라우저 환경 정보
                        </h5>
                        <div class="data-display p-3" style="background: #2d3748; border-radius: 10px; border: 1px solid #4a5568;">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>브라우저:</strong> <span id="browserInfo" class="text-info"></span></p>
                                    <p><strong>디바이스:</strong> <span id="deviceType" class="text-success"></span></p>
                                    <p><strong>화면 크기:</strong> <span id="screenSize" class="text-warning"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>User Agent:</strong> <span id="userAgent" class="text-secondary small"></span></p>
                                    <p><strong>JavaScript:</strong> <span id="jsEnabled" class="text-info"></span></p>
                                    <p><strong>팝업 허용:</strong> <span id="popupTest" class="text-danger"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 테스트 버튼들 -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <button id="popupTestBtn" class="btn btn-primary w-100">
                                <i class="fas fa-window-maximize me-2"></i>
                                팝업 테스트
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button id="sdkTestBtn" class="btn btn-info w-100">
                                <i class="fas fa-code me-2"></i>
                                Fintree SDK 테스트
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button id="paymentTestBtn" class="btn btn-success w-100">
                                <i class="fas fa-credit-card me-2"></i>
                                결제창 테스트
                            </button>
                        </div>
                    </div>

                    <!-- 해결 방안 -->
                    <div class="mt-4">
                        <h5 class="text-warning mb-3">
                            <i class="fas fa-tools me-2"></i>
                            문제 해결 방안
                        </h5>
                        <div id="solutions" class="data-display p-3" style="background: #2d3748; border-radius: 10px; border: 1px solid #4a5568;">
                            <div id="solutionsList"></div>
                        </div>
                    </div>

                    <!-- 뒤로가기 -->
                    <div class="text-center mt-4">
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            메인 페이지로
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fintree SDK -->
    <script src="https://api.fintree.kr/js/v1/pgAsistant.js" onerror="handleFintreeLoadError()"></script>

    <script>
        let diagnosticResults = [];
        let fintreeSDKLoaded = false;

        // 페이지 로드 시 자동 진단
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔍 PC 결제 문제 진단 시작');
            runAllDiagnostics();
        });

        // 전체 진단 실행
        function runAllDiagnostics() {
            diagnosticResults = [];
            
            // 기본 환경 정보 수집
            collectEnvironmentInfo();
            
            // 각종 테스트 실행
            testJavaScript();
            testPopupCapability();
            testFintreeSDK();
            testScreenSize();
            testBrowserCompatibility();
            
            // 결과 표시
            displayResults();
            generateSolutions();
        }

        // 환경 정보 수집
        function collectEnvironmentInfo() {
            const ua = navigator.userAgent;
            
            // 브라우저 감지
            let browser = 'Unknown';
            if (ua.includes('Chrome')) browser = 'Chrome';
            else if (ua.includes('Firefox')) browser = 'Firefox';
            else if (ua.includes('Safari')) browser = 'Safari';
            else if (ua.includes('Edge')) browser = 'Edge';
            
            // 디바이스 타입
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
            const deviceType = isMobile ? 'Mobile' : 'Desktop';
            
            // 화면 크기
            const screenSize = `${window.screen.width}x${window.screen.height}`;
            
            // 정보 표시
            document.getElementById('browserInfo').textContent = browser;
            document.getElementById('deviceType').textContent = deviceType;
            document.getElementById('screenSize').textContent = screenSize;
            document.getElementById('userAgent').textContent = ua;
            document.getElementById('jsEnabled').textContent = 'Enabled ✅';
            
            console.log('📊 환경 정보 수집 완료:', { browser, deviceType, screenSize });
        }

        // JavaScript 테스트
        function testJavaScript() {
            try {
                const testObj = { test: true };
                const testJson = JSON.stringify(testObj);
                const testParse = JSON.parse(testJson);
                
                if (testParse.test === true) {
                    addTestResult('JavaScript 기능', 'pass', 'JavaScript가 정상적으로 작동합니다');
                } else {
                    addTestResult('JavaScript 기능', 'fail', 'JavaScript JSON 처리에 문제가 있습니다');
                }
            } catch (error) {
                addTestResult('JavaScript 기능', 'fail', 'JavaScript 오류: ' + error.message);
            }
        }

        // 팝업 기능 테스트
        function testPopupCapability() {
            try {
                // 팝업 차단 여부 확인
                const popup = window.open('', '_blank', 'width=1,height=1');
                if (popup && popup.location) {
                    popup.close();
                    addTestResult('팝업 허용', 'pass', '팝업이 허용되어 있습니다');
                    document.getElementById('popupTest').textContent = 'Allowed ✅';
                } else {
                    addTestResult('팝업 허용', 'fail', '팝업이 차단되어 있습니다 - 결제창이 열리지 않을 수 있습니다');
                    document.getElementById('popupTest').textContent = 'Blocked ❌';
                }
            } catch (error) {
                addTestResult('팝업 허용', 'fail', '팝업 테스트 오류: ' + error.message);
                document.getElementById('popupTest').textContent = 'Error ❌';
            }
        }

        // Fintree SDK 테스트
        function testFintreeSDK() {
            setTimeout(() => {
                if (typeof SendPay !== 'undefined') {
                    addTestResult('Fintree SDK', 'pass', 'Fintree SDK가 정상적으로 로드되었습니다');
                    fintreeSDKLoaded = true;
                } else {
                    addTestResult('Fintree SDK', 'fail', 'Fintree SDK 로드 실패 - 결제 기능이 작동하지 않습니다');
                }
                displayResults();
            }, 2000); // 2초 후 확인
        }

        // 화면 크기 테스트
        function testScreenSize() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            if (width >= 1200) {
                addTestResult('화면 크기', 'pass', `데스크톱 해상도 (${width}x${height})`);
            } else if (width >= 768) {
                addTestResult('화면 크기', 'warn', `태블릿 해상도 (${width}x${height}) - 일부 기능이 제한될 수 있습니다`);
            } else {
                addTestResult('화면 크기', 'warn', `모바일 해상도 (${width}x${height}) - PC용 결제창에 문제가 있을 수 있습니다`);
            }
        }

        // 브라우저 호환성 테스트
        function testBrowserCompatibility() {
            const ua = navigator.userAgent;
            
            if (ua.includes('Chrome')) {
                addTestResult('브라우저 호환성', 'pass', 'Chrome - 결제 기능 완전 지원');
            } else if (ua.includes('Firefox')) {
                addTestResult('브라우저 호환성', 'warn', 'Firefox - 일부 보안 설정으로 인한 문제 가능');
            } else if (ua.includes('Safari')) {
                addTestResult('브라우저 호환성', 'warn', 'Safari - 팝업 및 보안 정책으로 인한 제한 가능');
            } else if (ua.includes('Edge')) {
                addTestResult('브라우저 호환성', 'pass', 'Edge - 결제 기능 지원');
            } else {
                addTestResult('브라우저 호환성', 'fail', '지원되지 않는 브라우저 - Chrome 또는 Edge 사용 권장');
            }
        }

        // 테스트 결과 추가
        function addTestResult(test, status, message) {
            diagnosticResults.push({ test, status, message });
        }

        // 결과 표시
        function displayResults() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';
            
            diagnosticResults.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-result test-${result.status}`;
                
                let icon = '';
                if (result.status === 'pass') icon = '✅';
                else if (result.status === 'fail') icon = '❌';
                else if (result.status === 'warn') icon = '⚠️';
                
                div.innerHTML = `<strong>${icon} ${result.test}:</strong> ${result.message}`;
                resultsDiv.appendChild(div);
            });
        }

        // 해결 방안 생성
        function generateSolutions() {
            const solutionsDiv = document.getElementById('solutionsList');
            const solutions = [];
            
            // 팝업 차단 문제
            const popupBlocked = diagnosticResults.some(r => r.test === '팝업 허용' && r.status === 'fail');
            if (popupBlocked) {
                solutions.push('🔧 <strong>팝업 차단 해제:</strong> 브라우저 설정에서 이 사이트의 팝업을 허용해주세요');
                solutions.push('🔧 <strong>주소창 팝업 아이콘:</strong> 결제 시도 시 주소창 옆 팝업 차단 아이콘을 클릭하여 허용해주세요');
            }
            
            // Fintree SDK 문제
            const sdkFailed = diagnosticResults.some(r => r.test === 'Fintree SDK' && r.status === 'fail');
            if (sdkFailed) {
                solutions.push('🔧 <strong>네트워크 확인:</strong> 인터넷 연결 상태를 확인해주세요');
                solutions.push('🔧 <strong>브라우저 새로고침:</strong> 페이지를 새로고침한 후 다시 시도해주세요');
                solutions.push('🔧 <strong>보안 프로그램:</strong> 방화벽이나 보안 프로그램에서 Fintree 도메인을 허용해주세요');
            }
            
            // 브라우저 호환성 문제
            const browserIssue = diagnosticResults.some(r => r.test === '브라우저 호환성' && (r.status === 'fail' || r.status === 'warn'));
            if (browserIssue) {
                solutions.push('🔧 <strong>권장 브라우저:</strong> Chrome 또는 Edge 브라우저 사용을 권장합니다');
                solutions.push('🔧 <strong>브라우저 업데이트:</strong> 최신 버전으로 업데이트해주세요');
            }
            
            // 기본 해결책
            solutions.push('🔧 <strong>모바일 결제:</strong> PC에서 문제가 지속되면 모바일 기기를 사용해주세요');
            solutions.push('🔧 <strong>고객센터:</strong> 계속 문제가 발생하면 고객센터로 문의해주세요');
            
            solutionsDiv.innerHTML = solutions.map(s => `<p class="mb-2">${s}</p>`).join('');
        }

        // Fintree SDK 로드 오류 처리
        function handleFintreeLoadError() {
            console.error('❌ Fintree SDK 로드 실패');
            addTestResult('Fintree SDK', 'fail', 'Fintree SDK 로드 실패 - 네트워크 또는 보안 설정 확인 필요');
            displayResults();
            generateSolutions();
        }

        // 버튼 이벤트 핸들러
        document.getElementById('popupTestBtn').addEventListener('click', function() {
            try {
                const popup = window.open('about:blank', '_blank', 'width=400,height=300');
                if (popup) {
                    popup.document.write(`
                        <html>
                            <head><title>팝업 테스트</title></head>
                            <body style="font-family: Arial; text-align: center; padding: 50px;">
                                <h2>✅ 팝업 테스트 성공!</h2>
                                <p>결제창이 정상적으로 열릴 수 있습니다.</p>
                                <button onclick="window.close()">닫기</button>
                            </body>
                        </html>
                    `);
                    setTimeout(() => popup.close(), 3000);
                } else {
                    alert('❌ 팝업이 차단되었습니다. 브라우저 설정에서 팝업을 허용해주세요.');
                }
            } catch (error) {
                alert('❌ 팝업 테스트 오류: ' + error.message);
            }
        });

        document.getElementById('sdkTestBtn').addEventListener('click', function() {
            if (typeof SendPay !== 'undefined') {
                alert('✅ Fintree SDK가 정상적으로 로드되었습니다.');
            } else {
                alert('❌ Fintree SDK가 로드되지 않았습니다. 페이지를 새로고침해주세요.');
            }
        });

        document.getElementById('paymentTestBtn').addEventListener('click', function() {
            if (fintreeSDKLoaded) {
                alert('✅ 결제 시스템이 준비되었습니다. 실제 결제를 진행해보세요.');
                window.location.href = '/payment_prepare.html';
            } else {
                alert('❌ Fintree SDK가 로드되지 않아 결제를 진행할 수 없습니다.');
            }
        });
    </script>
</body>
</html>